{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Edit Project Update: {{ project_update.project.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/edit-page.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Edit Project Update: {{ project_update.project.name }}</h1>
        <div>
            <a href="{% url 'weekly-meeting-detail' project_update.meeting.id %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Meeting
            </a>
            <a href="{% url 'weekly-project-update-detail' project_update.id %}" class="btn btn-info">
                <i class="fas fa-eye"></i> View Details
            </a>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0">
                <i class="fas fa-edit me-2"></i>Update Project: {{ project_update.project.name }}
            </h5>
        </div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}

                <!-- Nav tabs for better organization -->
                <ul class="nav nav-tabs mb-3" id="projectUpdateTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="status-tab" data-bs-toggle="tab" 
                            data-bs-target="#status" type="button" role="tab" aria-selected="true">
                            <i class="fas fa-info-circle me-1"></i>Status
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="metrics-tab" data-bs-toggle="tab" 
                            data-bs-target="#metrics" type="button" role="tab" aria-selected="false">
                            <i class="fas fa-chart-bar me-1"></i>Metrics
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="details-tab" data-bs-toggle="tab" 
                            data-bs-target="#details" type="button" role="tab" aria-selected="false">
                            <i class="fas fa-cogs me-1"></i>Details
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="team-tab" data-bs-toggle="tab" 
                            data-bs-target="#team" type="button" role="tab" aria-selected="false">
                            <i class="fas fa-users me-1"></i>Team
                        </button>
                    </li>
                </ul>

                <!-- Tab content -->
                <div class="tab-content" id="projectUpdateTabContent">
                    <!-- Status Tab -->
                    <div class="tab-pane fade show active" id="status" role="tabpanel">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <select name="smoke_automation_status" class="form-select" id="smokeStatus" data-current-value="{{ project_update.smoke_automation_status }}">
                                        <option value="hold">Hold</option>
                                        <option value="completed">Completed</option>
                                        <option value="in_progress">In Progress</option>
                                        <option value="na">N/A</option>
                                    </select>
                                    <label for="smokeStatus">Smoke Automation Status</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <select name="regression_automation_status" class="form-select" id="regressionStatus" data-current-value="{{ project_update.regression_automation_status }}">
                                        <option value="hold">Hold</option>
                                        <option value="completed">Completed</option>
                                        <option value="in_progress">In Progress</option>
                                        <option value="na">N/A</option>
                                    </select>
                                    <label for="regressionStatus">Regression Automation Status</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <select name="pipeline_schedule" class="form-select" id="pipelineSchedule" data-current-value="{{ project_update.pipeline_schedule }}">
                                        <option value="on_demand">On-Demand</option>
                                        <option value="weekly">Weekly</option>
                                        <option value="nightly">Nightly</option>
                                        <option value="na">N/A</option>
                                    </select>
                                    <label for="pipelineSchedule">Pipeline Schedule</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="number" name="regression_coverage" class="form-control" id="regressionCoverage" value="{{ project_update.regression_coverage }}" min="0" max="100">
                                    <label for="regressionCoverage">Regression Coverage (%)</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="text" name="last_automation_run_status" class="form-control" id="lastRunStatus" value="{{ project_update.last_automation_run_status }}">
                                    <label for="lastRunStatus">Last Automation Run Status</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="date" name="last_automation_run_date" class="form-control" id="lastRunDate" value="{% if project_update.last_automation_run_date %}{{ project_update.last_automation_run_date|date:'Y-m-d' }}{% endif %}">
                                    <label for="lastRunDate">Last Automation Run Date</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input type="checkbox" class="form-check-input" id="readiness_for_production" name="readiness_for_production" {% if project_update.readiness_for_production %}checked{% endif %}>
                                    <label class="form-check-label" for="readiness_for_production">Readiness for Production</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Metrics Tab -->
                    <div class="tab-pane fade" id="metrics" role="tabpanel">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="number" name="total_available_test_cases" class="form-control" id="totalAvailable" value="{{ project_update.total_available_test_cases }}" min="0">
                                    <label for="totalAvailable">Total Available Test Cases</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="number" name="total_automatable_test_cases" class="form-control" id="totalAutomatable" value="{{ project_update.total_automatable_test_cases }}" min="0">
                                    <label for="totalAutomatable">Total Automatable Test Cases</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="number" name="total_automated_test_cases" class="form-control" id="totalAutomated" value="{{ project_update.total_automated_test_cases }}" min="0">
                                    <label for="totalAutomated">Total Automated Test Cases</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="number" name="total_automated_smoke_test_cases" class="form-control" id="totalAutomatedSmoke" value="{{ project_update.total_automated_smoke_test_cases }}" min="0">
                                    <label for="totalAutomatedSmoke">Total Automated Smoke Test Cases</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="number" name="bugs_found_through_automation" class="form-control" id="bugsFound" value="{{ project_update.bugs_found_through_automation }}" min="0">
                                    <label for="bugsFound">Bugs Found Through Automation</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="number" name="functional_test_cases_count" class="form-control" id="functionalTests" value="{{ project_update.functional_test_cases_count }}" min="0">
                                    <label for="functionalTests">Functional Test Cases</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="number" name="business_test_cases_count" class="form-control" id="businessTests" value="{{ project_update.business_test_cases_count }}" min="0">
                                    <label for="businessTests">Business Test Cases</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Details Tab -->
                    <div class="tab-pane fade" id="details" role="tabpanel">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Execution Time</label>
                                <div class="input-group mb-3">
                                    <input type="number" name="execution_time_hours" class="form-control" value="{{ project_update.execution_time_hours }}" min="0" placeholder="Hours">
                                    <span class="input-group-text">hrs</span>
                                    <input type="number" name="execution_time_minutes" class="form-control" value="{{ project_update.execution_time_minutes }}" min="0" max="59" placeholder="Minutes">
                                    <span class="input-group-text">min</span>
                                </div>
                                <div class="form-text">Current: {{ project_update.get_execution_time_display|default:"Not specified" }}</div>
                            </div>
                            <div class="col-12">
                                <div class="form-floating mb-3">
                                    <textarea name="automation_framework_tech_stack" class="form-control" id="techStack" style="height: 100px">{{ project_update.automation_framework_tech_stack }}</textarea>
                                    <label for="techStack">Automation Framework/Tech Stack</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Team Tab -->
                    <div class="tab-pane fade" id="team" role="tabpanel">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="form-floating mb-3">
                                    <select name="team_lead" class="form-select" id="teamLead">
                                        <option value="">-- Select Team Lead --</option>
                                        {% for resource in resources %}
                                        <option value="{{ resource.id }}" {% if project_update.team_lead and project_update.team_lead.id == resource.id %}selected{% endif %}>{{ resource.name }}</option>
                                        {% endfor %}
                                    </select>
                                    <label for="teamLead">Team Lead</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating mb-3">
                                    <select name="sprint_cycle" class="form-select" id="sprintCycle">
                                        <option value="">-- Select Sprint Cycle --</option>
                                        {% for cycle in sprint_cycles %}
                                        <option value="{{ cycle.id }}" {% if project_update.sprint_cycle and project_update.sprint_cycle.id == cycle.id %}selected{% endif %}>{{ cycle.name }}</option>
                                        {% endfor %}
                                    </select>
                                    <label for="sprintCycle">Sprint Cycle</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating mb-3">
                                    <select name="oat_release_cycle" class="form-select" id="oatCycle">
                                        <option value="">-- Select OAT Release Cycle --</option>
                                        {% for cycle in oat_release_cycles %}
                                        <option value="{{ cycle.id }}" {% if project_update.oat_release_cycle and project_update.oat_release_cycle.id == cycle.id %}selected{% endif %}>{{ cycle.name }}</option>
                                        {% endfor %}
                                    </select>
                                    <label for="oatCycle">OAT Release Cycle</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-4 d-flex justify-content-end">
                    <a href="{% url 'weekly-meeting-detail' project_update.meeting.id %}" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-times me-1"></i>Cancel
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Set the selected values for dropdowns
        var selects = document.querySelectorAll('select[data-current-value]');
        selects.forEach(function(select) {
            var currentValue = select.getAttribute('data-current-value');
            if (currentValue) {
                select.value = currentValue;
            }
        });

        // Add change event listeners to status dropdowns
        var statusSelects = [
            document.querySelector('select[name="smoke_automation_status"]'),
            document.querySelector('select[name="regression_automation_status"]'),
            document.querySelector('select[name="pipeline_schedule"]')
        ];

        statusSelects.forEach(function(select) {
            if (!select) return;

            select.addEventListener('change', function() {
                var currentValue = select.getAttribute('data-current-value');
                var newValue = select.value;

                if (currentValue !== newValue) {
                    var currentText = '';
                    var newText = '';
                    var fieldName = select.labels[0].textContent;

                    // Get display text for current value
                    for (var i = 0; i < select.options.length; i++) {
                        if (select.options[i].value === currentValue) {
                            currentText = select.options[i].text;
                            break;
                        }
                    }

                    // Get display text for new value
                    for (var i = 0; i < select.options.length; i++) {
                        if (select.options[i].value === newValue) {
                            newText = select.options[i].text;
                            break;
                        }
                    }

                    if (!confirm('Are you sure you want to change ' + fieldName + ' from "' + currentText + '" to "' + newText + '"?')) {
                        // If user cancels, revert to the original value
                        select.value = currentValue;
                    } else {
                        // Add visual feedback for the change
                        this.classList.add('is-changed');
                        setTimeout(function() {
                            select.classList.remove('is-changed');
                        }, 1000);
                    }
                }
            });
        });

        // Add visual feedback when switching tabs
        var tabLinks = document.querySelectorAll('.nav-link');
        tabLinks.forEach(function(tabLink) {
            tabLink.addEventListener('click', function() {
                // Add a subtle animation to the tab content
                var tabContentId = this.getAttribute('data-bs-target');
                var tabContent = document.querySelector(tabContentId);
                if (tabContent) {
                    tabContent.style.animation = 'none';
                    setTimeout(function() {
                        tabContent.style.animation = 'fadeIn 0.3s ease';
                    }, 10);
                }
            });
        });

        // Add visual feedback when form fields are modified
        var formInputs = document.querySelectorAll('textarea, input[type="number"], input[type="date"], input[type="checkbox"]');
        formInputs.forEach(function(input) {
            input.addEventListener('change', function() {
                // Add a subtle highlight effect
                this.classList.add('is-changed');
                setTimeout(function() {
                    input.classList.remove('is-changed');
                }, 1000);
            });
        });
    });
</script>
{% endblock %}
