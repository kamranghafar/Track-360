{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Edit Product Update: {{ product_update.project.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/edit-page.css' %}">
<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.css" rel="stylesheet">
<style>
    .note-editor {
        margin-bottom: 20px;
    }
    .note-editor.note-frame {
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
    }
    .note-editor .note-toolbar {
        background-color: #f8f9fa;
        border-bottom: 1px solid #ced4da;
    }
    .note-statusbar {
        background-color: #f8f9fa;
    }
    .form-label {
        font-weight: 500;
        margin-bottom: 0.5rem;
    }
    .form-text {
        margin-top: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Edit Product Update: {{ product_update.project.name }}</h1>
        <div>
            <a href="{% url 'weekly-product-meeting-detail' product_update.meeting.id %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Meeting
            </a>
            <a href="{% url 'weekly-product-update-detail' product_update.id %}" class="btn btn-info">
                <i class="fas fa-eye"></i> View Details
            </a>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-primary text-dark">
            <h5 class="card-title mb-0">
                <i class="fas fa-edit me-2"></i>Update Product: {{ product_update.project.name }}
            </h5>
        </div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}

                <!-- Nav tabs for better organization -->
                <ul class="nav nav-tabs mb-3" id="productUpdateTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="product-notes-tab" data-bs-toggle="tab" 
                            data-bs-target="#product-notes-tab-content" type="button" role="tab" aria-selected="true">
                            <i class="fas fa-clipboard me-1"></i>Product Notes
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="problems-tab" data-bs-toggle="tab" 
                            data-bs-target="#problems-tab-content" type="button" role="tab" aria-selected="false">
                            <i class="fas fa-exclamation-triangle me-1"></i>Problems
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="solutions-tab" data-bs-toggle="tab" 
                            data-bs-target="#solutions-tab-content" type="button" role="tab" aria-selected="false">
                            <i class="fas fa-lightbulb me-1"></i>Solutions
                        </button>
                    </li>
                </ul>

                <!-- Tab content -->
                <div class="tab-content" id="productUpdateTabContent">
                    <!-- Product Notes Tab -->
                    <div class="tab-pane fade show active" id="product-notes-tab-content" role="tabpanel">
                        <div class="row g-3">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="product_notes" class="form-label">Product Notes</label>
                                    <textarea name="product_notes" class="form-control summernote" id="product_notes">{{ product_update.product_notes }}</textarea>
                                    <div class="form-text">Additional notes and information about the product</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Problems Tab -->
                    <div class="tab-pane fade" id="problems-tab-content" role="tabpanel">
                        <div class="row g-3">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="problems" class="form-label">Problems</label>
                                    <textarea name="problems" class="form-control summernote" id="problems">{{ product_update.problems }}</textarea>
                                    <div class="form-text">Problems identified during the meeting</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Solutions Tab -->
                    <div class="tab-pane fade" id="solutions-tab-content" role="tabpanel">
                        <div class="row g-3">
                            <div class="col-md-12">
                                <div class="mb-4">
                                    <label for="expected_solution" class="form-label">Expected Solution</label>
                                    <textarea name="expected_solution" class="form-control summernote" id="expected_solution">{{ product_update.expected_solution }}</textarea>
                                    <div class="form-text">Expected solution for the identified problems</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <select name="solution_timeline" class="form-select" id="solution_timeline" data-current-value="{{ product_update.solution_timeline }}">
                                        <option value="immediate">Immediate (1-2 days)</option>
                                        <option value="short">Short-term (1 week)</option>
                                        <option value="medium">Medium-term (2-4 weeks)</option>
                                        <option value="long">Long-term (1+ months)</option>
                                    </select>
                                    <label for="solution_timeline">Solution Timeline</label>
                                    <div class="form-text">Timeline for implementing the solution</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-4 d-flex justify-content-end">
                    <a href="{% url 'weekly-product-meeting-detail' product_update.meeting.id %}" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-times me-1"></i>Cancel
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Prevent the default rich text editor from initializing on these textareas
        const textareas = document.querySelectorAll('.summernote');
        textareas.forEach(function(textarea) {
            // Add a class that the rich-text-editor.js will check to avoid double initialization
            textarea.classList.add('no-default-editor');
            // Also set an attribute that rich-text-editor.js checks
            textarea.setAttribute('data-rich-text-initialized', 'true');
        });

        // Initialize Summernote rich text editors
        $('.summernote').summernote({
            height: 200,
            toolbar: [
                ['style', ['style']],
                ['font', ['bold', 'underline', 'clear']],
                ['color', ['color']],
                ['para', ['ul', 'ol', 'paragraph']],
                ['table', ['table']],
                ['insert', ['link']],
                ['view', ['fullscreen', 'codeview', 'help']]
            ],
            callbacks: {
                onChange: function(contents, $editable) {
                    // This ensures the textarea's value is updated for form submission
                    $(this).val(contents);
                }
            }
        });

        // Set the selected value for the solution_timeline dropdown
        var solutionTimelineSelect = document.querySelector('select[name="solution_timeline"]');
        if (solutionTimelineSelect) {
            var currentValue = solutionTimelineSelect.getAttribute('data-current-value');
            if (currentValue) {
                solutionTimelineSelect.value = currentValue;
            } else {
                // Default to medium if no value is set
                solutionTimelineSelect.value = 'medium';
            }
        }

        // Add visual feedback when switching tabs
        var tabLinks = document.querySelectorAll('.nav-link');
        tabLinks.forEach(function(tabLink) {
            tabLink.addEventListener('click', function() {
                // Add a subtle animation to the tab content
                var tabContentId = this.getAttribute('data-bs-target');
                var tabContent = document.querySelector(tabContentId);
                if (tabContent) {
                    tabContent.style.animation = 'none';
                    setTimeout(function() {
                        tabContent.style.animation = 'fadeIn 0.3s ease';
                    }, 10);
                }
            });
        });

        // Add visual feedback when form fields are modified
        var formInputs = document.querySelectorAll('select');
        formInputs.forEach(function(input) {
            input.addEventListener('change', function() {
                // Add a subtle highlight effect
                this.classList.add('is-changed');
                setTimeout(function() {
                    input.classList.remove('is-changed');
                }, 1000);
            });
        });
    });
</script>
{% endblock %}
