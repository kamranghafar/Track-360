{% extends 'dashboard/base.html' %}

{% block title %}Strategic Roadmap{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="h3 mb-4 text-gray-800">Strategic Roadmap</h1>

    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Quarter: {{ quarter }}</h6>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <a href="{% url 'roadmap-item-create-quarter' quarter_id=quarter.id %}" class="btn btn-primary btn-block mb-2">
                                <i class="fas fa-plus"></i> Add Roadmap Item
                            </a>
                            <a href="{% url 'roadmap-item-list' %}" class="btn btn-secondary btn-block">
                                <i class="fas fa-list"></i> View All Items
                            </a>
                        </div>
                    </div>

                    <!-- Timeline View -->
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-primary">Timeline View</h6>
                                </div>
                                <div class="card-body">
                                    {% if roadmap_items %}
                                        <div id="timeline"></div>
                                    {% else %}
                                        <div class="alert alert-info">
                                            No roadmap items found for this quarter. <a href="{% url 'roadmap-item-create-quarter' quarter_id=quarter.id %}">Add one now</a>.
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- List View -->
                    <div class="row mt-4">
                        <div class="col-md-12">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-primary">Roadmap Items</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                                            <thead>
                                                <tr>
                                                    <th>Title</th>
                                                    <th>Owner</th>
                                                    <th>Start Date</th>
                                                    <th>End Date</th>
                                                    <th>Status</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for item in roadmap_items %}
                                                <tr>
                                                    <td>{{ item.title }}</td>
                                                    <td>{{ item.owner.name }}</td>
                                                    <td>{{ item.start_date }}</td>
                                                    <td>{{ item.end_date }}</td>
                                                    <td>
                                                        {% if item.status == 'not_started' %}
                                                            <span class="badge bg-secondary">Not Started</span>
                                                        {% elif item.status == 'in_progress' %}
                                                            <span class="badge bg-primary">In Progress</span>
                                                        {% elif item.status == 'completed' %}
                                                            <span class="badge bg-success">Completed</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <a href="{% url 'roadmap-item-detail' pk=item.id %}" class="btn btn-info btn-sm">
                                                            <i class="fas fa-eye"></i>
                                                        </a>
                                                        <a href="{% url 'roadmap-item-update' pk=item.id %}" class="btn btn-primary btn-sm">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                        <a href="{% url 'roadmap-item-delete' pk=item.id %}" class="btn btn-danger btn-sm">
                                                            <i class="fas fa-trash"></i>
                                                        </a>
                                                    </td>
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                    <td colspan="6" class="text-center">No roadmap items found.</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/vis-timeline@7.7.0/dist/vis-timeline-graph2d.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>

<style>
    /* Enhanced Timeline Styling */
    #timeline {
        width: 100%;
        height: 450px;
        margin: 20px 0;
        border: 1px solid #e3e6f0;
        border-radius: 0.5rem;
        box-shadow: 0 0.15rem 0.5rem rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    /* Custom styling for timeline items */
    .vis-item {
        border-radius: 4px;
        border-width: 1px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .vis-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        z-index: 100 !important;
    }

    /* Status-specific styling */
    .completed-item {
        background-color: rgba(40, 167, 69, 0.85) !important;
        border-color: #28a745 !important;
        color: white !important;
    }

    .in-progress-item {
        background-color: rgba(0, 123, 255, 0.85) !important;
        border-color: #007bff !important;
        color: white !important;
    }

    .not-started-item {
        background-color: rgba(108, 117, 125, 0.85) !important;
        border-color: #6c757d !important;
        color: white !important;
    }

    /* Priority indicators */
    .high-priority {
        border-left: 4px solid #dc3545 !important;
    }

    .medium-priority {
        border-left: 4px solid #ffc107 !important;
    }

    .low-priority {
        border-left: 4px solid #28a745 !important;
    }

    /* Custom tooltip styling */
    .vis-tooltip {
        background-color: rgba(0, 0, 0, 0.8) !important;
        border: none !important;
        border-radius: 4px !important;
        color: white !important;
        padding: 10px !important;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2) !important;
        font-size: 13px !important;
        max-width: 300px !important;
        z-index: 1000 !important;
    }

    /* Timeline axis styling */
    .vis-timeline {
        border: none !important;
    }

    .vis-panel.vis-center,
    .vis-panel.vis-left,
    .vis-panel.vis-right,
    .vis-panel.vis-top,
    .vis-panel.vis-bottom {
        border-color: #e9ecef !important;
    }

    .vis-grid.vis-vertical {
        border-color: rgba(0, 0, 0, 0.05) !important;
    }

    .vis-time-axis .vis-text {
        color: #495057 !important;
        font-size: 12px !important;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        #timeline {
            height: 350px;
        }

        .vis-item .vis-item-content {
            padding: 3px 5px !important;
            font-size: 12px !important;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        try {
            // Get the timeline container
            var container = document.getElementById('timeline');
            if (!container) {
                console.error('Timeline container not found');
                return;
            }

            // Parse the timeline data
            var timelineDataString = '{{ timeline_data|escapejs }}';
            var timelineData = [];
            try {
                timelineData = JSON.parse(timelineDataString);
            } catch (parseError) {
                console.error('Error parsing timeline data:', parseError);
                container.innerHTML = '<div class="alert alert-danger">Error parsing timeline data. Please try refreshing the page.</div>';
                return;
            }

            // Check if we have data
            if (!timelineData || timelineData.length === 0) {
                console.warn('No timeline data available');
                container.innerHTML = '<div class="alert alert-warning">No roadmap items found for this quarter. <a href="{% url "roadmap-item-create-quarter" quarter_id=quarter.id %}" class="btn btn-primary btn-sm ml-2">Add one now</a></div>';
                return;
            }

            // Create the dataset
            var items = new vis.DataSet();

            // Add items to the dataset with enhanced styling
            timelineData.forEach(function(item) {
                // Determine status class
                var statusClass = '';
                if (item.status === 'completed') {
                    statusClass = 'completed-item';
                } else if (item.status === 'in_progress') {
                    statusClass = 'in-progress-item';
                } else {
                    statusClass = 'not-started-item';
                }

                // Determine priority class
                var priorityClass = '';
                if (item.priority === 'high') {
                    priorityClass = 'high-priority';
                } else if (item.priority === 'medium') {
                    priorityClass = 'medium-priority';
                } else {
                    priorityClass = 'low-priority';
                }

                // Create enhanced content with better formatting
                var content = `
                    <div class="timeline-item-content">
                        <strong>${item.title}</strong>
                        <div class="mt-1">
                            <span class="owner">${item.owner}</span>
                            <div class="progress mt-1" style="height: 6px;">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: ${item.progress}%;" 
                                     aria-valuenow="${item.progress}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100"></div>
                            </div>
                        </div>
                    </div>
                `;

                // Create enhanced tooltip with more details
                var tooltip = `
                    <div class="timeline-tooltip">
                        <h6 class="mb-2">${item.title}</h6>
                        <p><strong>Owner:</strong> ${item.owner}</p>
                        <p><strong>Status:</strong> ${item.status.replace('_', ' ')}</p>
                        <p><strong>Priority:</strong> ${item.priority}</p>
                        <p><strong>Progress:</strong> ${item.progress}%</p>
                        <p><strong>Period:</strong> ${moment(item.start_date).format('MMM D, YYYY')} - ${moment(item.end_date).format('MMM D, YYYY')}</p>
                        <p class="mb-0 mt-2 text-muted">Click for details</p>
                    </div>
                `;

                // Add the item to the dataset
                items.add({
                    id: item.id,
                    content: content,
                    start: item.start_date,
                    end: item.end_date,
                    className: statusClass + ' ' + priorityClass,
                    title: tooltip // Enhanced tooltip
                });
            });

            // Configure timeline options with enhanced UI/UX
            var options = {
                height: '450px',
                min: new Date('{{ quarter.start_date|date:"Y-m-d" }}'),
                max: new Date('{{ quarter.end_date|date:"Y-m-d" }}'),
                zoomable: true,
                moveable: true,
                tooltip: {
                    followMouse: true,
                    overflowMethod: 'cap',
                    delay: 300
                },
                orientation: {
                    axis: 'both',
                    item: 'top'
                },
                margin: {
                    item: {
                        horizontal: 10,
                        vertical: 8
                    },
                    axis: 5
                },
                stack: true,
                stackSubgroups: true,
                showCurrentTime: true,
                showMajorLabels: true,
                showMinorLabels: true,
                format: {
                    minorLabels: {
                        day: 'D',
                        month: 'MMM',
                        year: 'YYYY'
                    },
                    majorLabels: {
                        day: 'MMMM YYYY',
                        week: 'MMMM YYYY',
                        month: 'YYYY',
                        year: ''
                    }
                },
                timeAxis: { scale: 'day', step: 5 },
                // Add animation when loading
                animate: true,
                animateZoom: true
            };

            // Create the timeline
            var timeline = new vis.Timeline(container, items, options);

            // Add click event to navigate to item detail
            timeline.on('click', function(properties) {
                if (properties.item) {
                    // Use the correct URL path that matches the URL pattern in urls.py
                    window.location.href = '/dashboard/roadmap/items/' + properties.item + '/';
                }
            });

            // Add hover effect
            timeline.on('itemover', function(properties) {
                // Could add additional hover effects here if needed
            });

            // Make timeline responsive
            window.addEventListener('resize', function() {
                timeline.redraw();
            });

            console.log('Enhanced timeline initialized with ' + timelineData.length + ' items');

        } catch (error) {
            console.error('Error initializing timeline:', error);
            document.getElementById('timeline').innerHTML = '<div class="alert alert-danger">Error initializing timeline. Please try refreshing the page.</div>';
        }
    });
</script>
{% endblock %}
